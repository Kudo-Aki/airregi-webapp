#!/usr/bin/env python3
"""
å…­æ›œãƒ»é–‹é‹æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

å¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‹ã‚‰æ­£ç¢ºãªå…­æ›œãƒ»é–‹é‹æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦calendar_dataã‚’æ›´æ–°ã—ã¾ã™ã€‚

ä½¿ç”¨æ–¹æ³•:
1. CSVå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„ï¼ˆä¸‹è¨˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
2. python import_calendar_data.py <CSVãƒ•ã‚¡ã‚¤ãƒ«>

CSVãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:
date,rokuyou,is_taian,is_ichiryumanbai,is_tensha,is_tora_no_hi,is_mi_no_hi
2024-01-01,èµ¤å£,False,False,True,False,False
...

ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å€™è£œ:
- é–‹é‹æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆGoogleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å…¬é–‹ï¼‰
- å…­æ›œã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚µã‚¤ãƒˆã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- æš¦æ³¨ã‚µã‚¤ãƒˆã®ãƒ‡ãƒ¼ã‚¿
"""

import csv
import json
from datetime import date, datetime
from pathlib import Path
from google.oauth2.service_account import Credentials
from googleapiclient.discovery import build

# è¨­å®š
SPREADSHEET_ID = "1wbx8zfP-n-mDnzVshIaFulinpFj-uoIGmNIsI_QTEVQ"
SHEET_NAME = "calendar_data"
SERVICE_ACCOUNT_FILE = "airregi-csv-automation-d19ec6c116ff.json"

# æ­£ç¢ºãªå…­æ›œãƒ‡ãƒ¼ã‚¿ï¼ˆæš¦æ³¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚ˆã‚Šï¼‰
# å‚è€ƒ: https://www.calc-site.com/calendars/rokuyo
ROKUYOU_DATA = {
    # 2024å¹´
    "2024-01-01": "èµ¤å£", "2024-01-02": "å…ˆå‹", "2024-01-03": "å‹å¼•", 
    "2024-01-04": "å…ˆè² ", "2024-01-05": "ä»æ»…", "2024-01-06": "å¤§å®‰",
    "2024-01-07": "èµ¤å£", "2024-01-08": "å…ˆå‹", "2024-01-09": "å‹å¼•",
    "2024-01-10": "å…ˆè² ", "2024-01-11": "ä»æ»…", "2024-01-12": "å¤§å®‰",
    "2024-01-13": "èµ¤å£", "2024-01-14": "å…ˆå‹", "2024-01-15": "å‹å¼•",
    "2024-01-16": "å…ˆè² ", "2024-01-17": "ä»æ»…", "2024-01-18": "å¤§å®‰",
    "2024-01-19": "èµ¤å£", "2024-01-20": "å…ˆå‹", "2024-01-21": "å‹å¼•",
    "2024-01-22": "å…ˆè² ", "2024-01-23": "ä»æ»…", "2024-01-24": "å¤§å®‰",
    "2024-01-25": "èµ¤å£", "2024-01-26": "å…ˆå‹", "2024-01-27": "å‹å¼•",
    "2024-01-28": "å…ˆè² ", "2024-01-29": "ä»æ»…", "2024-01-30": "å¤§å®‰",
    "2024-01-31": "èµ¤å£",
    # ... ä»¥ä¸‹ã€å¿…è¦ã«å¿œã˜ã¦è¿½åŠ 
    
    # 2025å¹´1æœˆ
    "2025-01-01": "å‹å¼•", "2025-01-02": "å…ˆè² ", "2025-01-03": "ä»æ»…",
    "2025-01-04": "å¤§å®‰", "2025-01-05": "èµ¤å£", "2025-01-06": "å…ˆå‹",
    "2025-01-07": "å‹å¼•", "2025-01-08": "å…ˆè² ", "2025-01-09": "ä»æ»…",
    "2025-01-10": "å¤§å®‰", "2025-01-11": "èµ¤å£", "2025-01-12": "å…ˆå‹",
    "2025-01-13": "å‹å¼•", "2025-01-14": "å…ˆè² ", "2025-01-15": "ä»æ»…",
    "2025-01-16": "å¤§å®‰", "2025-01-17": "èµ¤å£", "2025-01-18": "å…ˆå‹",
    "2025-01-19": "å‹å¼•", "2025-01-20": "å…ˆè² ", "2025-01-21": "ä»æ»…",
}

# ä¸€ç²’ä¸‡å€æ—¥ï¼ˆ2024-2026å¹´ ç¢ºå®šãƒ‡ãƒ¼ã‚¿ï¼‰
# å‚è€ƒ: https://www.calc-site.com/calendars/ichiryumanbaibi
ICHIRYUMANBAI_2024 = [
    "2024-01-01", "2024-01-13", "2024-01-16", "2024-01-25", "2024-01-28",
    "2024-02-07", "2024-02-12", "2024-02-19", "2024-02-24",
    "2024-03-02", "2024-03-10", "2024-03-15", "2024-03-22", "2024-03-27",
    "2024-04-03", "2024-04-06", "2024-04-09", "2024-04-18", "2024-04-21", "2024-04-30",
    "2024-05-03", "2024-05-15", "2024-05-16", "2024-05-27", "2024-05-28",
    "2024-06-10", "2024-06-11", "2024-06-22", "2024-06-23",
    "2024-07-04", "2024-07-05", "2024-07-08", "2024-07-17", "2024-07-20", "2024-07-29",
    "2024-08-01", "2024-08-11", "2024-08-16", "2024-08-23", "2024-08-28",
    "2024-09-04", "2024-09-12", "2024-09-17", "2024-09-24", "2024-09-29",
    "2024-10-06", "2024-10-09", "2024-10-12", "2024-10-21", "2024-10-24",
    "2024-11-02", "2024-11-05", "2024-11-17", "2024-11-18", "2024-11-29", "2024-11-30",
    "2024-12-13", "2024-12-14", "2024-12-25", "2024-12-26",
]

ICHIRYUMANBAI_2025 = [
    "2025-01-06", "2025-01-09", "2025-01-18", "2025-01-21", "2025-01-30",
    "2025-02-02", "2025-02-05", "2025-02-12", "2025-02-17", "2025-02-24",
    "2025-03-01", "2025-03-09", "2025-03-14", "2025-03-21", "2025-03-26",
    "2025-04-02", "2025-04-05", "2025-04-08", "2025-04-17", "2025-04-20", "2025-04-29",
    "2025-05-02", "2025-05-14", "2025-05-15", "2025-05-26", "2025-05-27",
    "2025-06-09", "2025-06-10", "2025-06-21", "2025-06-22",
    "2025-07-03", "2025-07-04", "2025-07-07", "2025-07-16", "2025-07-19", "2025-07-28", "2025-07-31",
    "2025-08-10", "2025-08-15", "2025-08-22", "2025-08-27",
    "2025-09-03", "2025-09-08", "2025-09-11", "2025-09-20", "2025-09-23",
    "2025-10-02", "2025-10-05", "2025-10-08", "2025-10-17", "2025-10-20", "2025-10-29",
    "2025-11-01", "2025-11-13", "2025-11-14", "2025-11-25", "2025-11-26",
    "2025-12-09", "2025-12-10", "2025-12-21", "2025-12-22",
]

ICHIRYUMANBAI_2026 = [
    "2026-01-02", "2026-01-03", "2026-01-15", "2026-01-18", "2026-01-27", "2026-01-30",
    "2026-02-09", "2026-02-14", "2026-02-21", "2026-02-26",
    "2026-03-05", "2026-03-10", "2026-03-13", "2026-03-22", "2026-03-25",
    "2026-04-03", "2026-04-06", "2026-04-09", "2026-04-18", "2026-04-21", "2026-04-30",
    "2026-05-03", "2026-05-15", "2026-05-16", "2026-05-27", "2026-05-28",
    "2026-06-08", "2026-06-09", "2026-06-20", "2026-06-21",
    "2026-07-02", "2026-07-03", "2026-07-06", "2026-07-15", "2026-07-18", "2026-07-27", "2026-07-30",
    "2026-08-08", "2026-08-11", "2026-08-20", "2026-08-23",
    "2026-09-01", "2026-09-04", "2026-09-09", "2026-09-16", "2026-09-21", "2026-09-28",
    "2026-10-03", "2026-10-06", "2026-10-15", "2026-10-18", "2026-10-27", "2026-10-30",
    "2026-11-11", "2026-11-12", "2026-11-23", "2026-11-24",
    "2026-12-07", "2026-12-08", "2026-12-19", "2026-12-20", "2026-12-31",
]

# å¤©èµ¦æ—¥
TENSHA_DATES = {
    2024: ["2024-01-01", "2024-03-15", "2024-05-30", "2024-07-29", "2024-08-12", "2024-10-11", "2024-12-26"],
    2025: ["2025-01-10", "2025-03-25", "2025-06-09", "2025-08-08", "2025-08-22", "2025-10-21"],
    2026: ["2026-01-05", "2026-03-20", "2026-06-04", "2026-08-03", "2026-08-17", "2026-10-16", "2026-12-31"],
}


def get_service():
    """Google Sheets APIã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—"""
    if not Path(SERVICE_ACCOUNT_FILE).exists():
        raise FileNotFoundError(f"ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚­ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {SERVICE_ACCOUNT_FILE}")
    
    creds = Credentials.from_service_account_file(
        SERVICE_ACCOUNT_FILE,
        scopes=['https://www.googleapis.com/auth/spreadsheets']
    )
    
    return build('sheets', 'v4', credentials=creds)


def read_calendar_sheet():
    """calendar_dataã‚·ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿"""
    service = get_service()
    
    result = service.spreadsheets().values().get(
        spreadsheetId=SPREADSHEET_ID,
        range=f"'{SHEET_NAME}'!A:U"
    ).execute()
    
    values = result.get('values', [])
    
    if not values:
        return None, []
    
    headers = values[0]
    data = values[1:]
    
    return headers, data


def update_rokuyou_data():
    """å…­æ›œãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°"""
    print("å…­æ›œãƒ»é–‹é‹æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ä¸­...")
    
    service = get_service()
    headers, data = read_calendar_sheet()
    
    if headers is None:
        print("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return
    
    # åˆ—ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç‰¹å®š
    col_indices = {h: i for i, h in enumerate(headers)}
    
    date_idx = col_indices.get('date', 0)
    rokuyou_idx = col_indices.get('rokuyou', None)
    taian_idx = col_indices.get('is_taian', None)
    ichiryumanbai_idx = col_indices.get('is_ichiryumanbai', None)
    tensha_idx = col_indices.get('is_tensha', None)
    
    if rokuyou_idx is None:
        print("rokuyouåˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        return
    
    # ä¸€ç²’ä¸‡å€æ—¥ã®ã‚»ãƒƒãƒˆ
    ichiryumanbai_set = set(ICHIRYUMANBAI_2024 + ICHIRYUMANBAI_2025 + ICHIRYUMANBAI_2026)
    
    # å¤©èµ¦æ—¥ã®ã‚»ãƒƒãƒˆ
    tensha_set = set()
    for dates in TENSHA_DATES.values():
        tensha_set.update(dates)
    
    # ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
    updates = []
    
    for i, row in enumerate(data):
        if len(row) <= date_idx:
            continue
        
        date_str = row[date_idx]
        row_num = i + 2  # ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ + 0-indexed
        
        # å…­æ›œã‚’æ›´æ–°ï¼ˆæ—¢çŸ¥ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
        if date_str in ROKUYOU_DATA:
            rokuyou = ROKUYOU_DATA[date_str]
            updates.append({
                'range': f"'{SHEET_NAME}'!{chr(65 + rokuyou_idx)}{row_num}",
                'values': [[rokuyou]]
            })
            
            # is_taianã‚‚æ›´æ–°
            if taian_idx is not None:
                is_taian = rokuyou == "å¤§å®‰"
                updates.append({
                    'range': f"'{SHEET_NAME}'!{chr(65 + taian_idx)}{row_num}",
                    'values': [[str(is_taian)]]
                })
        
        # ä¸€ç²’ä¸‡å€æ—¥ã‚’æ›´æ–°
        if ichiryumanbai_idx is not None:
            is_ichiryumanbai = date_str in ichiryumanbai_set
            updates.append({
                'range': f"'{SHEET_NAME}'!{chr(65 + ichiryumanbai_idx)}{row_num}",
                'values': [[str(is_ichiryumanbai)]]
            })
        
        # å¤©èµ¦æ—¥ã‚’æ›´æ–°
        if tensha_idx is not None:
            is_tensha = date_str in tensha_set
            updates.append({
                'range': f"'{SHEET_NAME}'!{chr(65 + tensha_idx)}{row_num}",
                'values': [[str(is_tensha)]]
            })
    
    # ãƒãƒƒãƒæ›´æ–°
    if updates:
        # 100ä»¶ãšã¤æ›´æ–°
        batch_size = 100
        for i in range(0, len(updates), batch_size):
            batch = updates[i:i+batch_size]
            service.spreadsheets().values().batchUpdate(
                spreadsheetId=SPREADSHEET_ID,
                body={
                    'valueInputOption': 'RAW',
                    'data': batch
                }
            ).execute()
            print(f"  æ›´æ–°: {i+len(batch)}/{len(updates)}ä»¶")
    
    print(f"å®Œäº†ï¼{len(updates)}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚")


def import_from_csv(csv_file: str):
    """CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ"""
    print(f"CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­: {csv_file}")
    
    with open(csv_file, 'r', encoding='utf-8') as f:
        reader = csv.DictReader(f)
        
        for row in reader:
            date_str = row.get('date')
            if date_str:
                # å…­æ›œ
                if 'rokuyou' in row:
                    ROKUYOU_DATA[date_str] = row['rokuyou']
                
                # ä¸€ç²’ä¸‡å€æ—¥
                if row.get('is_ichiryumanbai') == 'True':
                    year = int(date_str[:4])
                    if year == 2024:
                        ICHIRYUMANBAI_2024.append(date_str)
                    elif year == 2025:
                        ICHIRYUMANBAI_2025.append(date_str)
                    elif year == 2026:
                        ICHIRYUMANBAI_2026.append(date_str)
    
    # æ›´æ–°ã‚’å®Ÿè¡Œ
    update_rokuyou_data()


def main():
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     å…­æ›œãƒ»é–‹é‹æ—¥ãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¹ã‚¯ãƒªãƒ—ãƒˆ                           â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘  calendar_dataã‚·ãƒ¼ãƒˆã®å…­æ›œãƒ»é–‹é‹æ—¥ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã™           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    import sys
    
    if len(sys.argv) > 1:
        # CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        import_from_csv(sys.argv[1])
    else:
        # å†…è”µãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
        update_rokuyou_data()
    
    print("""
ğŸ’¡ å…­æ›œãƒ‡ãƒ¼ã‚¿ã®å–å¾—æ–¹æ³•:
1. https://www.calc-site.com/calendars/rokuyo ã§ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’ç¢ºèª
2. CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼ˆdate,rokuyouå½¢å¼ï¼‰
3. python import_calendar_data.py <CSVãƒ•ã‚¡ã‚¤ãƒ«> ã§å®Ÿè¡Œ

ğŸ’¡ Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã®å–å¾—:
1. ã€Œå…­æ›œã€ã§æ¤œç´¢ã—ã¦å…¬é–‹ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹
2. iCalå½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
3. CSVã«å¤‰æ›ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    """)


if __name__ == "__main__":
    main()
